# nginx configuration for Matrix - Direct to Synapse (no Traefik)
# Matrix domain: matrix.test.local
# Element domain: element.test.local

# Matrix server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name matrix.test.local;

    # SSL certificates from mkcert
    ssl_certificate /matrix/ssl/cert.pem;
    ssl_certificate_key /matrix/ssl/privkey.pem;

    # Basic SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Matrix well-known files for client discovery
    location /.well-known/matrix/client {
        return 200 '{"m.homeserver": {"base_url": "https://matrix.test.local"}}';
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    location /.well-known/matrix/server {
        return 200 '{"m.server": "matrix.test.local:443"}';
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # Matrix Client-Server API
    location /_matrix {
        # Proxy directly to Synapse on localhost:8008
        # proxy_pass with NO trailing slash preserves the full URL path including encoding
        proxy_pass http://127.0.0.1:8008;

        # Required headers for Synapse
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Use HTTP/1.1 for backend connection
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Timeouts for long-polling sync requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Logging
        access_log /var/log/nginx/matrix-synapse.access.log;
        error_log /var/log/nginx/matrix-synapse.error.log;

        # Increase max upload size for media
        client_max_body_size 50M;
    }

    # Matrix Synapse Admin API (if enabled)
    location /_synapse {
        proxy_pass http://127.0.0.1:8008;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;

        access_log /var/log/nginx/matrix-synapse.access.log;
        error_log /var/log/nginx/matrix-synapse.error.log;
    }

    # Root path - return info
    location / {
        return 200 '{"server": "matrix.test.local", "info": "Matrix homeserver - Element client at https://element.test.local"}';
        default_type application/json;
    }
}

# Element web client on separate domain
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name element.test.local;

    # SSL certificates from mkcert
    ssl_certificate /matrix/ssl/cert.pem;
    ssl_certificate_key /matrix/ssl/privkey.pem;

    # Basic SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Element web client
    location / {
        proxy_pass http://127.0.0.1:8765;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;

        # Logging
        access_log /var/log/nginx/matrix-element.access.log;
        error_log /var/log/nginx/matrix-element.error.log;
    }
}

# Matrix federation on port 8448
server {
    listen 8448 ssl http2;
    listen [::]:8448 ssl http2;

    server_name matrix.test.local;

    # SSL certificates from mkcert
    ssl_certificate /matrix/ssl/cert.pem;
    ssl_certificate_key /matrix/ssl/privkey.pem;

    # Basic SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        # Proxy to Synapse federation API on localhost:8048
        proxy_pass http://127.0.0.1:8048;

        # Forward headers
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;

        # Logging
        access_log /var/log/nginx/matrix-federation.access.log;
        error_log /var/log/nginx/matrix-federation.error.log;

        # Increase max upload size
        client_max_body_size 50M;
    }
}

# HTTP to HTTPS redirect for both domains
server {
    listen 80;
    listen [::]:80;
    server_name matrix.test.local element.test.local;

    return 301 https://$host$request_uri;
}
